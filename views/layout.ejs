<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title><%= title || "Valenti Dreams" %></title>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap"
			rel="stylesheet" />
		<link rel="stylesheet" href="/css/style.css" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
	</head>
	<body class="theme-<%= theme %>">
		<div class="container">
			<header>
				<div class="header-div">
					<h1><a href="/">Valenti Dreams</a></h1>
					<img src="/logo.png" alt="Valenti Dreams Logo" class="app-logo" />
				</div>
				<nav>
					<a href="/" class="nav-icon" aria-label="Home"
						><i class="fas fa-home"></i
					></a>
					<a href="/sessions" class="nav-icon" aria-label="Sessions"
						><i class="fas fa-spa"></i
					></a>

					<% if (user) { %>
					<a href="/profile" class="nav-icon" aria-label="My Profile"
						><i class="fas fa-user"></i
					></a>
					<button id="cart-toggle" class="nav-icon cart-btn" aria-label="View Cart">
						<i class="fas fa-shopping-cart"></i>
						<% if (cart && cart.length > 0) { %>
						<span class="cart-badge"><%= cart.length %></span>
						<% } %>
					</button>
					<% } else { %>
					<a href="/login" class="nav-icon" aria-label="Sign In"
						><i class="far fa-user"></i
					></a>
					<% } %>

					<button
						id="theme-toggle"
						class="theme-toggle"
						aria-label="Toggle theme">
						<i class="fas fa-<%= theme === 'dark' ? 'sun' : 'moon' %>"></i>
					</button>
				</nav>
			</header>
			<main><%- body %></main>
			<footer>
				<p>&copy; 2025 Valenti Dreams - Beyond consciousness</p>
			</footer>
		</div>

		<div id="cart-backdrop" class="cart-backdrop"></div>
		<div id="cart-drawer" class="cart-drawer">
			<div class="drawer-header">
				<h3>Your Cart</h3>
				<button id="close-drawer" class="close-btn">&times;</button>
			</div>
			<div class="drawer-content">
				<% if (!cart || cart.length === 0) { %>
				<div class="empty-drawer">
					<p>Your cart is empty</p>
					<a href="/sessions" class="btn">Browse Sessions</a>
				</div>
				<% } else { %>
				<ul class="drawer-list">
					<% cart.forEach(function(item) { %>
					<li class="drawer-item">
						<div class="item-info">
							<span class="item-title"><%= item.session.title %></span>
							<span class="item-meta"
								><%= item.quantity %> x <%= item.session.price %>€</span
							>
						</div>
						<a href="/cart/remove/<%= item.session.id %>" class="remove-item"
							><i class="fas fa-trash-alt"></i
						></a>
					</li>
					<% }); %>
				</ul>
				<div class="drawer-footer">
					<div class="drawer-total">
						<span>Total</span>
						<span
							><%= cart.reduce((acc, item) => acc + (item.session.price *
							item.quantity), 0) %>€</span
						>
					</div>
					<a
						href="/cart"
						class="btn btn-outline"
						style="
							width: 100%;
							margin-bottom: 12px;
							border: 1px solid var(--primary);
							background: transparent;
							color: var(--primary);
						"
						>View Detailed Cart</a
					>
					<form action="/cart/checkout" method="POST">
						<button type="submit" class="btn" style="width: 100%">
							Checkout
						</button>
					</form>
				</div>
				<% } %>
			</div>
		</div>

		<script>
			(function () {
				// Theme Toggle Logic
				let currentTheme = '<%= theme %>';
				const themeBtn = document.getElementById('theme-toggle');
				const themeIcon = themeBtn.querySelector('i');

				themeBtn.addEventListener('click', () => {
					const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
					document.body.classList.remove('theme-' + currentTheme);
					document.body.classList.add('theme-' + newTheme);
					themeIcon.classList.remove(
						'fa-' + (currentTheme === 'dark' ? 'sun' : 'moon')
					);
					themeIcon.classList.add('fa-' + (newTheme === 'dark' ? 'sun' : 'moon'));
					currentTheme = newTheme;
					fetch('/api/theme', {
						method: 'POST',
						headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
						body: 'theme=' + newTheme,
					});
				});

				const cartBtn = document.getElementById('cart-toggle');
				const cartDrawer = document.getElementById('cart-drawer');
				const cartBackdrop = document.getElementById('cart-backdrop');
				const closeBtn = document.getElementById('close-drawer');

				if (cartBtn) {
					cartBtn.addEventListener('click', () => {
						cartDrawer.classList.add('open');
						cartBackdrop.classList.add('show');
						document.body.style.overflow = 'hidden';
					});
				}

				const closeDrawer = () => {
					cartDrawer.classList.remove('open');
					cartBackdrop.classList.remove('show');
					document.body.style.overflow = '';
				};

				if (closeBtn) closeBtn.addEventListener('click', closeDrawer);
				if (cartBackdrop) cartBackdrop.addEventListener('click', closeDrawer);
			})();
		</script>
	</body>
</html>